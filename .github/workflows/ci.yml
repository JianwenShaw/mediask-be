name: CI

on:
  pull_request:
    branches: [master, dev]
  push:
    branches: [dev, master]
  # 允许其他工作流调用
  workflow_call:

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build & Test
        run: mvn -B -U verify

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/*.xml
            **/target/site/jacoco/jacoco.xml

  # CI 失败通知（暂时禁用，需配置邮件 secrets 后启用）
  # notify-failure:
  #   name: Notify Failure
  #   needs: test
  #   if: failure() && github.event_name != 'workflow_call'
  #   uses: ./.github/workflows/notify.yml
  #   with:
  #     status: failure
  #     workflow_name: CI
  #     version: ${{ github.ref_name }}
  #     failure_stage: Build & Test
  #     run_id: ${{ github.run_id }}
  #     run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  #   secrets:
  #     MAIL_SERVER: ${{ secrets.MAIL_SERVER }}
  #     MAIL_PORT: ${{ secrets.MAIL_PORT }}
  #     MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
  #     MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
  #     MAIL_TO: ${{ secrets.MAIL_TO }}
