name: Email Notification

on:
  workflow_call:
    inputs:
      status:
        description: "Build status: success or failure"
        required: true
        type: string
      workflow_name:
        description: "Name of the calling workflow"
        required: true
        type: string
      version:
        description: "Version or branch name"
        required: false
        type: string
        default: ""
      failure_stage:
        description: "Which stage failed (for failure notifications)"
        required: false
        type: string
        default: "æœªçŸ¥é˜¶æ®µ"
      run_id:
        description: "The workflow run ID"
        required: true
        type: string
      run_url:
        description: "URL to the workflow run"
        required: true
        type: string
    secrets:
      MAIL_SERVER:
        required: true
      MAIL_PORT:
        required: true
      MAIL_USERNAME:
        required: true
      MAIL_PASSWORD:
        required: true
      MAIL_TO:
        required: true

jobs:
  send-notification:
    name: Send Email
    runs-on: ubuntu-latest

    steps:
      - name: Send success email
        if: inputs.status == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          from: MediAsk CI/CD <${{ secrets.MAIL_USERNAME }}>
          to: ${{ secrets.MAIL_TO }}
          subject: "âœ… [MediAsk] ${{ inputs.workflow_name }} ${{ inputs.version }} æ„å»ºæˆåŠŸ"
          html_body: |
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h1 style="margin: 0; font-size: 24px;">âœ… æ„å»ºæˆåŠŸ</h1>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">MediAsk ${{ inputs.workflow_name }} ${{ inputs.version }}</p>
              </div>
              
              <div style="background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-top: none;">
                <h2 style="color: #374151; font-size: 16px; margin-top: 0;">ğŸ“¦ æ„å»ºä¿¡æ¯</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">å·¥ä½œæµ</td>
                    <td style="padding: 8px 0; color: #111827; font-weight: 500;">${{ inputs.workflow_name }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">ç‰ˆæœ¬/åˆ†æ”¯</td>
                    <td style="padding: 8px 0; color: #111827; font-weight: 500;">${{ inputs.version || 'N/A' }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">Commit</td>
                    <td style="padding: 8px 0; font-family: monospace; color: #111827;">${{ github.sha }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">è§¦å‘è€…</td>
                    <td style="padding: 8px 0; color: #111827;">${{ github.actor }}</td>
                  </tr>
                </table>
                
                <div style="background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 6px; padding: 15px; margin-top: 15px;">
                  <p style="margin: 0; color: #065f46; font-size: 14px;">
                    ğŸ‰ æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼Œæ„å»ºæˆåŠŸå®Œæˆï¼
                  </p>
                </div>
              </div>
              
              <div style="background: #f3f4f6; padding: 15px 20px; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb; border-top: none;">
                <a href="${{ inputs.run_url }}" 
                   style="display: inline-block; background: #3b82f6; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-size: 14px;">
                  æŸ¥çœ‹æ„å»ºè¯¦æƒ… â†’
                </a>
              </div>
            </div>

      - name: Send failure email
        if: inputs.status == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          from: MediAsk CI/CD <${{ secrets.MAIL_USERNAME }}>
          to: ${{ secrets.MAIL_TO }}
          subject: "âŒ [MediAsk] ${{ inputs.workflow_name }} ${{ inputs.version }} æ„å»ºå¤±è´¥"
          html_body: |
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h1 style="margin: 0; font-size: 24px;">âŒ æ„å»ºå¤±è´¥</h1>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">MediAsk ${{ inputs.workflow_name }} ${{ inputs.version }}</p>
              </div>
              
              <div style="background: #fef2f2; padding: 20px; border: 1px solid #fecaca; border-top: none;">
                <h2 style="color: #991b1b; font-size: 16px; margin-top: 0;">âš ï¸ å¤±è´¥ä¿¡æ¯</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">å·¥ä½œæµ</td>
                    <td style="padding: 8px 0; color: #111827; font-weight: 500;">${{ inputs.workflow_name }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">ç‰ˆæœ¬/åˆ†æ”¯</td>
                    <td style="padding: 8px 0; color: #111827; font-weight: 500;">${{ inputs.version || 'N/A' }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">Commit</td>
                    <td style="padding: 8px 0; font-family: monospace; color: #111827;">${{ github.sha }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">è§¦å‘è€…</td>
                    <td style="padding: 8px 0; color: #111827;">${{ github.actor }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: #6b7280;">å¤±è´¥é˜¶æ®µ</td>
                    <td style="padding: 8px 0; color: #dc2626; font-weight: 500;">${{ inputs.failure_stage }}</td>
                  </tr>
                </table>
                
                <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; padding: 15px; margin-top: 15px;">
                  <p style="margin: 0; color: #991b1b; font-size: 14px;">
                    <strong>è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š</strong>
                  </p>
                  <ul style="color: #7f1d1d; font-size: 13px; margin: 10px 0 0 0; padding-left: 20px;">
                    <li>å•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•å¤±è´¥</li>
                    <li>ä»£ç ç¼–è¯‘é”™è¯¯</li>
                    <li>ä¾èµ–ä¸‹è½½å¤±è´¥</li>
                    <li>Docker æ„å»ºé—®é¢˜</li>
                    <li>è®¤è¯æˆ–æƒé™é—®é¢˜</li>
                  </ul>
                </div>
              </div>
              
              <div style="background: #f3f4f6; padding: 15px 20px; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb; border-top: none;">
                <a href="${{ inputs.run_url }}" 
                   style="display: inline-block; background: #dc2626; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-size: 14px;">
                  æŸ¥çœ‹å¤±è´¥æ—¥å¿— â†’
                </a>
              </div>
            </div>



